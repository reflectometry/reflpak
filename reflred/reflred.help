# ----------------------------------------------------------------------
if { [llength [info var ::app_version]] > 0 } {
    set about_version $::app_version
} else {
    set about_version "Reflred [clock format [clock seconds] -format %Y%m%d]"
}
hpage About {} [string map [list %V $about_version] {
%V

 NIST Center for Neutron Research
 Reflectivity reduction software.

Please send suggestions and bugs to reflectometry_software@nist.gov

Except where stated in the individual files, this software
is a work of the government and is in the public domain (see [disclaimer]).

The source release includes the following packages:

 ctext.tcl by George Peter Staplin
 htext.tcl by Richard Suchenwirth
 balloonhelp.tcl by Jeffery Hobbs
 sizer.tcl by Kai Morich

Binary releases include the following additional packages:

 Tcl/Tk by John Ousterhout, et al.,
 DQkit by Wojciech Kocjan (based on Jean-Claude Wippler's starkit)
 BLT by George Howlett, et al.,
 Tktable by Jeffrey Hobbs
 Tkdnd by George Petasis, et al.,
 tkcon by Jeffrey Hobbs, et al.,
 BWidget by Eric Boudaillier, et al. now maintained by Jeffrey Hobbs

Paul Kienzle 2004-03-22
}]


hpage disclaimer {} {
This software was developed at the National Institute of Standards and
Technology at the NIST Center for Neutron Research by employees of the
Federal Government in the course of their official duties. Pursuant
to title 17 section 105* of the United States Code this software is
not subject to copyright protection and is in the public domain. The
reflfit software package is an experimental neutron reflectometry analysis
system. NIST assumes no responsibility whatsoever for its use, and makes
no guarantees, expressed or implied, about its quality, reliability, or
any other characteristic. The use of certain trade names or commercial
products does not imply any endorsement of a particular product, nor does
it imply that the named product is necessarily the best product for the
stated purpose. We would appreciate acknowledgment if the software is used.

*Subject matter of copyright: United States Government works

Copyright protection under this title is not available for any work of the
United States Government, but the United States Government is not precluded
from receiving and holding copyrights transferred to it by assignment,
bequest, or otherwise.  
}

# ----------------------------------------------------------------------
hpage windows {Reflred is a program for viewing and reducing X-Ray and
neutron reflectometry data.

There are a number of different windows in the system.

The [choose] window lets you select directory and dataset.

The [compose] window lets you select files and compose scans.

The [psd] window lets you view position sensitive detector scans.

The [attenuator] window lets you set the attenuator values for each run in
a complete scan.

The [print] window lets you set the graph size and output destination.  Only
postscript graphs are available at present.

The [reduce] window lets you combine scans.

The [footprint correction] window lets you set the footprint correction 
parameters for the reduction.

The [Tcl console] window lets you interact directly with Tcl/Tk.

The [help] window lets you browse the help text.

2002-09-13}

# ===============================================================
hpage print {.graph.print .reduce.print} {
Print options for your graph.  Which graph gets printed depends how
you got here.  To print the compose graph click the Print button on
the compose screen.  To print the reduce graph click the Print button
on the reduce screen. There is no support for printing the attenuator 
table or the footprint parameters.

The options on the left define the graph:

>center centers the graph

>landscape selects between portrait and landscape mode

>maxpect preserves the aspect ratio of the graph

>preview generates a preview in the postscript file which 
programs such as xdvi can use to display the graph

>decorations determines the color of the graph border

>colormode should be color for a color printer.  Support 
for black and white printers is weak --- there is no 
attempt to use different dash patterns for the lines.

The options on the right define the paper.  The defaults
work for 8 1/2 x 11 paper.

Output can either be to a postscript file or directly to the printer.
If it is directly to a printer, use "|lpr -P<printer>".  Consult your
local contact regarding the names and locations of the various printers.

2003-01-17}


# ----------------------------------------------------------------------
hpage attenuator .attenuator {See also [attenuator controls].

Enter attenuator values.  Use Ctrl-C and Ctrl-V to copy and paste
values from one row to the next.

There are commands available from the [Tcl console] to adjust the
attenuators.

Calculate attenuation between two records with one overlapping point:

  atten_from_overlap R1 R2

Calculate attenuation between two records with n overlapping points:

  atten_from_overlap R1 R2 n

Skip k points from the end of the overlap region:

  atten_from_overlap R1 R2 end-n+1:end-k 0:k-1

Copy attenuator values from R1 to R2, R3, ... and Rk

  atten_copy R1 R2 R3 ... Rk

Set attenuator from ratio

  atten_from_ratio R1 k dk

Set attenuator from sums for numerator and denominator

  atten_from_counts R1 n1 n2

Get sums from the screen with n corresponding points

  atten_from_screen n

2005-09-27}

#This window contains the attenuator scale factors for each segment of 
#the run.  Enter attenuator values into the table.  You can also enter
#expressions.

#At present the "align" button on the [compose] window doesn't work very well.
#It only works if the curves overlap at a single point.  It
#aligns every curve in the sequence, even if two curves are
#about equal, so the estimated error is very large.  It does
#not find the best attenuator value to use for all overlapping
#curves.  Do not use it for correct reduction, but you can use
#it to get a quick view of your aligned curves.

# It is possible to align a pair of overlapping curves using
# shift-right-click.  This will give a list of overlapping
# curves and you can select one to align with.  *This is work
# in progress!*  The value is only correct if there is a single
# point of overlap.  If the attenuation on the two curves is
# approximately equal you should copy the values from one to
# the other rather than aligning them.  You can do this by
# clicking on the value you want to copy, then center-clicking
# where you want to copy it to, or if you prefer the keyboard,
# use the copy and paste keys (Ctrl-C, Ctrl-V).


# ----------------------------------------------------------------------
hpage {attenuator controls} {} {See also [attenuator].

navigation
    Mouse: click to change cell
    Keys:  <Up>/<Down> to move up/down
	   <Tab>/<Backtab> to move right/left
	   <Return> to accept value without moving

setting attenuators
    Keys:  <Ctrl-C> to copy selected text to clipboard
	   <Ctrl-V> to replace selection with text from clipboard
	   <Ctrl-X> to clear the selection
    Mouse: middle-click to paste the selected value in a new cell
	   shift-right-click to align or clear a single row


2002-09-13}

# ----------------------------------------------------------------------
hpage compose . {See also [compose controls] [windows] 

The run composer is the main window of reflred.  From
here you can view and plot individual data files, and compose them
into complete scans.  You can access most of the other [windows] 
directly from the menu.

The initial list contains data files from the directory/pattern
given on the command line, or from the current directory if none was
given.  You can select a different data set from the [choose] window
(Data... on the menu).

Files are grouped according to the activity of the motors:

>It is a slit scan if the beam is straight through 
but the slit motors are moving.

>It is a rocking curve if the incident angle 
is fixed but the reflected angle is varying.

>It is a specular scan if the incident angle 
matches the reflected angle.

>It is a background scan if the incident angle 
does not match the reflected angle.  

Background scans are tagged with + if the reflected angle is greater
than the incident angle, or - if the reflected angle is greater than
the incident angle.

There are a few rare scan types possible.  A height scan is indicated
by movement of motor 12 on NG-7.  If no motors are moving, but
temperature is being recorded then it will be classified as a
temperature scan.  Similarly for applied field.  If nothing is
changing then the file is tagged as a time evolution (or a single
point slit scan if the beam is straight through).

Shown next to each data file is a box indicating the total range for
the data set.  The shaded portion of the box indicates the Qz range
for that file.  The vertical bar indicates a value of Qz = 0, or for
Qx = 0 in the case of rocking curves.  For slit scans, the data range
indicates the slit 1 opening.  For temperature scans, time evolution,
or height scans, the data range indicates temperature, time or height
respectively.

For NG-1 and X-Ray files there is no data column for Qz.  Instead
Qz is calculated from motor A3 (incident angle) or A4 (incident
plus reflected angle).  For rocking curves it must be A3 and
for specular scans it doesn't matter since A3 is 2*A4.  For background
scans however either A3 or A4 can be the basis for Qz, with the other
being the offset.  This is indicated in the file selection tree by
the label Background Q(A3) or Background Q(A4).  It should be obvious
which is correct by comparing the Q range of the background with the
Q range of the corresponding specular.  Click the label to toggle, or
select "Options Background A#" from the menu to change them all.  Doing
so will change the Q range on the selected files as well, but not on
the previously composed scans.

All runs are displayed with the same monitor count, which is the
monitor of the first run selected (see [monitor]).  You can scale each run
independently using the [attenuator] window (Attenuator... in the
menu), or click "align" to calculate the attenuators automatically.
WARNING: the attenuator calculator does not work reliably.  Read 
the details in [attenuator].

Note: you cannot combine NG1 runs counted against monitor and time in 
the same scan.  The NG1 monitor is positioned between slit 1 and slit 2,
so as slit 1 opens, the monitor rate increases which means the counting
time decreases within the run.  When counting against time, the
counting time is fixed within the run. The correct way to handle this 
is to reduce the monitor and time data separately then join the 
reduced lines.

NG-7 data is scaled by monitor count when it is loaded.  A dead
time correction is applied to the monitor count, which is linearly
interpolated from the data in the file reflectivity/NG7monitor.cal.  
You can see the calibration data by opening the [Tcl console] and typing
	load_NG7_monitor_calibration
	set NG7_monitor_calibration

Since the NG7 monitor does not count every neutron, there will be 
a detector to monitor ratio that needs to be measured.  Once 
measured, this can be entered on the reduce screen as a transmission 
coefficient, entered as an attenuator, or saved as an ICP file and
used as a slit scan.  Since the detector to monitor ratio is
not a constant especially at low Q, a slit scan taken at several
points will give the best results.

Once you have selected your sequence of files, click "Accept" to
average them into a complete scan.  The resulting average will be
displayed as a separate scan line.  Click on the legend entry to hide
it, or click "Clear" to remove it.  The "Clear" button first removes
the selected runs, then removes the scans.  Scans are available for
further processing in the [reduce] window (Reduce... in the menu).

For polarized beam, you will have to select A, B, C and D separately.
Once you accept, separate lines will be created for each index.

2002-09-13}

# ----------------------------------------------------------------------
hpage {compose controls} {} {See also [compose].

open/close runlist subtree
    Mouse: click on +/- box where the subtree branches
    Keys:  <Up> or <Down> to highlight then <Right> or <Left> to toggle

change background motor basis
    Mouse: click the Background Q(A#) label to toggle one
    Menu:  choose Options Background Q(A3/A4) to set all

select/clear files
    Mouse: click on run number to toggle, double-click to toggle sequence
	   shift-click on run to force, shift-double-click to force sequence
	   right-click in list or "Clear" to clear all files
	   right-click in list or "Clear" again to clear all scans
	   middle-click in list or "Accept" to save scan and clear all files
    Keys:  <Up>/<Down> to highlight
	   <Return> to toggle, <Control-Return> to toggle sequence
	   <Shift-Return> to force, <Shift-Control-Return> to force sequence
	   <Insert> to accept sequence then clear
	   <Delete> to clear all files
	   <Delete> again to clear all scans

display run file
    Mouse: shift-click on run number to view file, click-drag on sash to 
           make the viewing area bigger.  You could simply click on the 
	   run number, but that will toggle the selection.  
    Keys:  <Up>/<Down> changes file without altering the selection.

graph controls
    Mouse: click on legend entry to hide/show line segment
	   click on y-axis to toggle linear/log scale
	   right-click on y-axis to hide/show all line segments on that axis
	   hover on points on graph to show coordinates
	   middle-click on points on graph to exclude from further analysis
	   click-move-click on graph instead of click-drag-release to zoom
	   right-click on graph unzoom

2002-09-03}


# ----------------------------------------------------------------------
hpage monitor .monitor {Since 
the reflectivity curve changes by orders of magnitude in intensity
as a function of Q, different scan points must be measured for different
amounts of time.  Before lines can be combined in the reflectivity
calculation, they must be normalized to the same counting basis.  Once
they are normalized, the data can be scaled arbitrarily for display
purposes.  The monitor window lets you select how the data is displayed.

Because different data is taken with different monitors, and because
the default display scale uses the monitor value of the first record
displayed the actual counts displayed for a particular point may vary
depending on which other records are displayed.  To keep a consistent
value no matter what the display, use a fixed scale.  Fields are
provided for fixed monitor counts and fixed seconds separately since
some data is normalized by time and other by monitor.  

The choice of normalization is inherent in the record.  Ideally all
records will contain a monitor column giving an estimate of the
number of neutrons available.  Sometimes the monitor is not available
or not reliable and the record should be normalized against seconds
rather than monitors.  To do so it is necessary to leave the graphical 
user interface.  First select the record that should be changed so 
that its contents are visible in the text window.  Next type the 
following in the [Tcl console]:

  monitor_set $rec(id) seconds

The data will now be normalized by the ::seconds_$rec(id) column. You 
can change all visible records with a single command:

  monitor_set $::addrun seconds

These changes will last until you deselect and reselect the file.  You
can also force normalization by monitor by calling the following:

  monitor_set $::addrun monitor

Normalizing against time assumes the variation in beam rate is
small, which is not necessarily the case (e.g., power bumps due to
weather conditions affecting the electrical supply), so use with
caution.

Be careful when mixing monitor and time data in the graph. You can view them 
on the same scale by fixing the scale and entering the counts per second 
in counts and 1 in seconds.  This does not change the value stored in the
file, but it does allow you to view the data together.  As of this writing
the data for time and monitor will not be correctly combined.  Instead,
reduce time and monitor data separately and combine the resulting reflectivity
curves.

In certain rare cases mixing monitor and time data will be unavoidable, but 
handling them is beyond the scope of the graphical user interface. Instead, 
use the Tcl console to construct specific monitor or seconds vectors.  The
function monitor_gen can generate either monitor or seconds given a monitor
rate. For example, to generate a time column from a monitor column in the 
current record assuming the monitor measures 5132 counts measured over 3 
seconds, use:

  monitor_gen $rec(id) seconds 5132 3

2005-09-27}


# ----------------------------------------------------------------------
hpage reduce .reduce {See also [reduce controls].

The reduce window is where you collect the various scans to create the
reflectivity signal.  This is a confusing screen.

The basic formula is (specular-background)/slitscan.  In addition there
is scaling by the [transmission coefficient] of the sample environment,
polarization correction for polarized beam and [footprint correction].

Select all specular lines.  These will appear on the legend annotated with
a plus, and the "specular" entry will show the average of all the specular
lines.  The highlighted line is the final reduction, which at this
point will just be the average of the specular.  So selecting one line
will display it overlayed by the identical average overlayed by the
identical reduced line.

Next select all background lines.  These will appear on the legend
annotated with a minus, the "background" entry will show the average
of all the background lines, and the "subtracted" entry will show the
difference between the specular and the background. The highlighted 
reduced line will now overlay the subtracted line. Note that [psd] 
data will already have the background subtracted from the specular, 
so no need to select any. 

For NG-1 and X-ray data you need to divide by a slit-scan.  This is 
a sequence of data taken with the same slit settings as the specular 
and background data but directly counting the beam rather than its
reflection. Because the detector is directly in line with the beam for
a slit scan, there is no Qz value intrinsic to the specific slit openings.
Instead for each Qz in the specular data, you must lookup the value of
the slit 1 opening for that particular Qz in the slit data and this is
your slit scan.  Linear interpolation is used if the slit values are
not exactly aligned.  NG-7 data does not use slit scans but instead 
the specular and background data is divided by the monitor count when 
the data is loaded.  Note that NG-7's monitor does not count all
incident neutrons.  Instead, you will have a "slit to monitor" ratio
by which you need to scale the reflectivity curve.  You can enter this
value as a factor in the "incident medium transmission coefficient" or
if it is measured in a file, divided it through as a single point
slit scan \[untested as of this writing\].  Note that the slit to monitor
ratio decreases as the slit width approaches zero, so for careful 
experiments you may want to measure the slit scan across many points.

Select all the slit scan lines.   These will appear on the legend 
annotated with a slash, but will not appear on the graph.  If you 
select the legend entry, the actual data will appear but it will
be counts versus slit 1 where slit 1 values go across the top axis
rather than along the bottom axis, so there will be no correspondence
with the Qz values of the specular or background curves.  The slit 
scan entry represents Qz value of the specular interpolated into the 
average of all the individual slit scans.  The divided entry is 
(specular - background)/slit, which will be overlayed by the 
highlighted reduced line.

The next step is to calculate the [footprint correction].  Click the
Parameters... button to enter the footprint parameters.  You can
suppress the footprint correction by toggling the associated check
box on this screen.

Finally, you can scale the data by the "incident medium transmission
coefficient".  If you "Guess" at the value, then it will scale the data
so that the peak reflectivity is 1.0.  The error on the scale factor
will equal the error on the peak value.

Save your data as linear and/or print the graph and you are done.  The
header will contain details of all the files which went into the reduced
(Q,R,dR) data columns.

2002-09-18}

hpage {transmission coefficient} {} {See also [reduce].

Transmission coefficient is a scalar multiplier for the reflectivity and
can be used for several different purposes:  

 * For NG-7 data is divided by the monitor.  If you set the transmission
   coefficient to the detector to monitor ratio (usually about 12) you will 
   get normalized reflectivity.

 * For sample environments with significant absorption, set the transmission
   coefficient to the attenuation you expect through the medium.

 * For back reflectivity, where the beam enters the side of the substrate
   and reflects off the back side of the film, set the transmission 
   coefficient to the absorption you expect in the substrate.

These effects are multiplicative.

If you don't know the correct value of the transmission coefficient, you
can guess by looking at the data below the critical angle.  There is a
flat region which should be perfectly reflecting.  Take the average of
the values in this region and use that for the transmission coefficient.
The "Guess" button in Reflred uses the maximum value of the reflectivity
rather than the average value.

Please make sure the guessed value makes sense.  If for example the
critical edge is too low, you may not see it in the data and the
guessed transmission coefficient will be too high.

2005-04-22}

# ----------------------------------------------------------------------
hpage {reduce controls} {} {See also [reduce].

select scans
    Mouse: click to select, click again to clear
    Keys:  <Tab>/<Back Tab> to focus, arrows to choose, space to select

graph controls
    Mouse: click on legend entry to hide/show line segment
	   click on y-axis to toggle linear/log scale
	   right-click on y-axis to hide/show all line segments on that axis
	   hover on points on graph to show coordinates
	   middle-click on points on graph to exclude from further analysis
	   click-move-click on graph instead of click-drag-release to zoom
	   right-click on graph unzoom

2002-09-18}

# ----------------------------------------------------------------------
hpage {footprint correction} .footprint {
If the incident slits are fixed, the fraction of the sample area
illuminated by the beam increases without bound as the incident angle  
(theta) decreases.  For high Q, you can avoid correcting for this 
geometrical effect and simultaneously increase the flux incident on the
sample by linearly opening the slits with increasing angle such that a
constant area of the sample is illuminated at each Q.

For small Q, however, the variable slit openings would then approach
zero as the angle decreases and the flux incident on the sample may be
too small.  As a result the slits are sometimes held fixed for small Q
and an ever-increasing fraction of the beam will spill over the sample
surface as the incident angle approaches zero (Fig 1).  For fixed or
variable slits, the signal will rise sharply near zero as the detector 
enters the main beam.

	[img::footprint.gif]
	Fig. 1: Beam spills over the sample edges as the
	incident angle approaches zero.

Our goal with footprint correction is to compensate for the geometric
effects resulting from the use of fixed slits.   Assuming a rectangular
sample (or a fully illuminated sample of arbitrary shape), the fraction
of beam which intercepts the sample will decrease linearly with Q.
Since sin(theta) ~ theta near theta=0, the portion will also decrease
linearly with incident angle.  To correct for this effect, you should 
divide by a line up until the end of the correction region, and a
constant thereafter.

There are several cases:

(1) A flat region is apparent below the critical angle: Normalizes 
this flat region to one (e.g., by fitting the plateau) and ignore all 
data below the flat region.

[img::fpflat.gif]
	Fig 2: Flat region after "V".  The plateau is marked with
	red "+". Fit to intercept b (the slope m is zero).

Note that you should have some explanation for why intensity of the
plateau is not unity.  For example, if the slit scan was taken in
air but the reflected intensity was measured in vacuum, the 
plateau will be above unity.  Similarly, if the beam is wider than 
the sample, not all the beam will be reflected, and the plateau will
be below unity.

(2) The data linearly increases below the critical angle:  Approximate
the footprint correction by fitting a line to the linear region,   
stopping the fit where the data curve into the critical region.  The
footprint correction window will tell you the Q value where the
footprint correction is equal to 1.  You should apply the footprint  
correction up to that Q value or up to the end of the fixed slit region,
whichever occurs at the lowest Q.

[img::fplinear.gif]
	Fig 3: No flat region after "V". Linear portion is marked
	with red "+".  Fit to line m*Qz+b.  Note the linear scale 
	on the right hand axis.

>(3) Neither a flat region nor a sloped region is evident below the  
critical angle:  In this case calculate the footprint correction from
the geometry of your sample and enter it directly  (Tools for this
calculation are not yet available in reflred).  If your sample is not
rectangular, you may not be able to calculate the footprint correction,
and you will need to measure it (see below).

Since the second case is the most common, we consider it here in more
detail.  First zoom into the reduce graphs so that you can see both
the fixed slit region simultaneous with the corresponding
reflectivity.  Be sure that the y-axis for the reflectivity uses a
_linear_ scale so that you can locate the flat portion of the rising
slope.  Click Parameters... to select the footprint fit parameters.

In the footprint window, select 'Fit footprint correction' and click
the 'From graph...' button.  You will want to first select the lowest
Q point of your data which does not include scattering from the main
beam.  (This is at the bottom of the "V" in the reflectivity signal
assuming you have measured below about 0.005 inv Angstroms).  Next
choose the last point which is approximately linear.  Make sure the
m*Qz+b selection is active (use b if fitting a plateau, use m*Qz if you
want to constrain the footprint to go through zero a Qz = 0).

Having specified the slope and intercept, or having selected the fit
region from the graph, you must then select the portion of the curve
over which to apply the footprint correction.  You can again click
'From graph...' to select points from the graph.  Usually the
correction should be applied from the bottom of the "V" to the Q value
corresponding to the end of the fixed slit region.

For NG1 and X-ray data, the fixed slit region will be obvious from the
measured slit scan.  For NG7 you will have to go back to the data
selection window and examine the first file in your specular sequence
to see where the fixed slit region stops.  \[Use the right mouse
button on the specular scan you are using from the list of specular
scans and select 'Edit'.]  Often NG7 data is taken with continously
varying slits.

Click the Apply button to fit and apply the footprint
correction. Notice that the value of the footprint correction
specified at the end of the application range divided through the
entire Q range of your reflectivity scan.  This value, listed at the
bottom of the footprint dialog, should be less than one.  If it is
not, use the Qz value where the correction is 1.0 given on the next
line as the upper end of "Correct from" range.

Your footprint correction is now complete.  If you do not wish to
apply it, click off the "Footprint correction" check box on the [reduce]
screen.

Note that if your sample is not rectangular or fully illuminated, 
the footprint correction will no longer be linear.  In that case
you will have to measure the footprint correction directly (Case 3).  
First measure a sample of the same dimension and with a critical angle
greater than the fixed slit region for your experiment.  Reduce that
scan (being sure to divide by a slit scan if necessary) and save it.
Now select the scan you wish to correct and click 'Parameters...' to
get to the footprint window.  Choose the footprint scan from the
'Measured footprint correction' dropdown list.  From the graph, select
the region you want to correct as zero to the critical angle of the
footprint scan.

2003-11-03}

# ----------------------------------------------------------------------
hpage {psd} .psd {See also [psd controls].

Position sensitive detector data is a 2-D array.  Instead of a single
pencil detector a linear array of detectors is deployed, so for each
incident angle you can simultaneously measure an array of reflected
angles.  Each Qz slice in the ICP file thus corresponds to a rocking
curve.  From this curve we can estimate the specular and background
signal simultaneously.

The psd window shows four different graphs.  The top left graph shows
data from the entire PSD array as a false color plot.  Below and beside
this are graphs of slices through the array.  On the bottom right is
a graph of the specular, background and subtracted data derived from
the array. The legend on the top right shows the colour values 
corresponding to the levels in the array.  

There are two dashed vertical lines overlaying the array.  The data 
between these lines is integrated to form the specular scan.  An equal 
width region surrounding the specular region is integrated to form 
the background scan.  These are subtracted to form the reduced data.
Once the region is selected, you can use the [attenuator] window to 
scale the data as usual.  The graph to the right shows the levels 
for each line.

By clicking the middle button in the array you can get a cross section
through the data.  The vertical slice shows the counts versus Qz and
is shown on the graph to the right.  The diagonal slice shows the 
counts for a constant Qz on the graph below.

2002-09-18}

# ----------------------------------------------------------------------
hpage {psd controls} {} {See also [psd].

change region of integration:
>click and drag thick dashed lines.  Click and drag the ends of the
line to change the slope of the line.  If you can't click and drag,
it may be because the crosshairs are stealing the mouse, so click 
the center mouse button somewhere else on the graph to move the 
crosshairs and try again.

log/linear scaling:

>click on any y-axis to change all axes from log to linear (including
the colormap)

zoom image or reduction:

>click-move-click to zoom, right-click to unzoom

slice:

>center click or alt+right click to draw a slice going through the coordinates

>shift+center click or alt+shift+right click to change the angle of the slice

2003-10-26}


# ----------------------------------------------------------------------
hpage {Tcl console} .tkcon {Tcl 
is an easy to learn scripting language in which you will eventually be
able to automate your data reduction if you take your data
systematically.  

I will not attempt to describe tcl here.  See
http://www.msen.com/~clif/TclTutor.html for an interactive tutorial.

At present, the reduction is set up to be driven by the GUI, so
although you could automate it now it would be awkward to do so.
Here are some incomplete notes to get you started.  Be warned 
that the information given below is subject to change
without notice as the scripting interface evolves.

The active set of records is determined by a call to setdirectory.  This
takes a file pattern, categorizes all the matching files and displays them
in the file selection tree.  E.g., to load all the ng7 files in your
reflectivity directory you might use:

	setdirectory ~/refl/*.ng7

Information about individual files are stored in arrays in the global
namespace.  The name of the array is visible in parentheses beside the
name of the file when the file is selected.  You can see what information
is being stored for each file using "array get".  E.g.,

	array get R1

To find the record associated with a particular file name, use
the function rec which searches through all categorized files for a file
of the given name.  E.g., to find 074A of dataset f524b use:

	rec f542b074.na1

This maps the array rec to the record found, so you can see the fields
using, e.g., puts $rec(file).

Records can be added to or removed from the current scan using 
toggle_section.  The following command adds R3 to the current
scan.  The keep option makes sure that it is an add, since otherwise
it will be a toggle.

	toggle_section -keep 1 -node R3

You can manipulate the data directly by accessing the [data record].
For example, you can set an attenuator factor using:

	set R2(k) 23.
	set R2(dk) 0.1

If you change the attenuator by hand, be sure to call the following to 
update the display:

	monitor_reset

Once all the records are selected and the attenuators are set, you can
accept the scan with a call to addrun accept.  A table of all accepted 
scans is stored in scanindex. You can examine an individual scan with 
array get scan#, where # is the number of the scan given in the scan 
index.

	addrun accept
	array get scanindex

The rest of reduction is even less amenable to scripting.  To use
e.g. scan1 you will need to find "$scan1(name) $scan1(comment)" in
the listbox for .reduce.$scan1(type) to get the index (see the function
listbox_ordered_insert in generic.tcl for clues how to do this), then
you will need to force that index to be selected (see the listbox manual
page for clues).  Footprint correction is more awkward still.

2005-09-27}

hpage {data record} {Once 
a file is selected and displayed in the graph, the data is easily
accessed from the [Tcl console].  Individual columns are stored as BLT 
vectors. To see the vectors associated with e.g., R1 use:

	vector names *_R1

The following vector names will be created for each record (if possible).  
It may be that the value is the same for all points, in which case it 
will be a vector of constants.

  monitor,dmonitor  Monitor counts for each point
  seconds,dseconds  Measurement duration (seconds)
  counts,dcounts    Raw counts from the file
  y,dy              Intensity as normalized counts scaled by attenuator
  temp              Temperature during measurement (C)
  idx	            Index of included points

  rec(norm)         Normalization basis for I (monitor or second)
  rec(monitor)      Default monitor 
  rec(k),rec(dk)    Attenuator value

  alpha             Incident angle (degrees)
  beta              Detector angle (degrees)
  Qx,Qz             Q value (inv Angstroms)
  slit1,slit2       Pre-sample slit values (mm)
  slit3,slit4       Post-sample slit values (mm)

  XXX               data for column XXX as stored in the file

  x                 x data (probably a copy of Qz)
  ky	            y data scaled to display monitor
  kdy	            dy uncertainty scaled to display monitor


Note that not all records will exist for all files at all times.
y and dy will change whenever attenuators or normalization basis changes.
idx will change whenever a point is included or excluded.

2005-09-27}

# ----------------------------------------------------------------------
hpage choose .choose {
The left side shows directories, the right side shows datasets.

Click a directory name to display the datasets available in that
directory.  Double-click to change to that directory.  The "."
directory is the current directory.  The ".." is the parent. All
others are subdirectories.

Click on a dataset to only work with that dataset, or click nothing to
work with all datasets simultaneously.  Click on a column header to
sort by that column (dataset name, instrument, number of runs in that
dataset, earliest run, latest run, comment).

Click "Apply" or "Ok" to categorize all files in the dataset/directory
selected.  "Apply" leaves the choose window open, "Ok" closes it.
Click "Cancel" to close the choose window.

2002-09-13}

# ----------------------------------------------------------------------
hpage {Algorithm: Joining lines} {When joining multiple measurements
into a single measurement, nearby points are combined.  Nearby is defined
as having a Q value with 2e-14 of each other.  Ideally, points with 
different resolution would be kept separate but as of this writing they
are not.

To average rates y1, ..., yn, selected from use:

     w = sum{ y_i/dy_i^2 }
     y = sum{ (y_i/dy_i)^2 }/w
     dy = sqrt( y_i/w )

where yi is the rate ni/mi computed from the counts over the monitor
and dyi is the uncertainty sqrt(ni)/mi due to Poisson statistics.
Note that avg(y1,...,yn) == avg(y1,avg(y2, ..., avg(yn-1,yn)...)),
and the order in which the lines are added does not matter.  This
formula does not apply to values selected from Gaussian distributions.

For a pair of points, this expands to the following:

   measure N counts during M monitors
   rate:                   r = N/M
   rate uncertainty:      dr = sqrt(N)/M
   weighted rate:          r/dr^2 = (N/M) / (N/M^2) =  M
   weighted rate squared:  r^2/dr^2 = (N^2/M) / (N/M^2) = N

   for two measurements N_a, N_b
   w = r_a/dr_a^2 + r_b/dr_b^2 = M_a + M_b
   y = ((r_a/dr_a)^2 + (r_b/dr_b)^2)/w = (N_a + N_b)/(M_a + M_b)
   dy = sqrt(y/w) = sqrt( (N_a + N_b)/ w^2 ) = sqrt(N_a+N_b)/(M_a + M_b)

We are actually using a more complicated expression for rate which
includes attenuators and for rate uncertainty which includes attenuator
and monitor uncertainty propogated using Gaussian statistics, so in
practice it will be:

   r = A*N/M
  dr = sqrt( A^2*(1+N/M)*N + (dA*N)^2 )/M

As a check for the formula, the rate and uncertainty for two separate
measurements Na and Nb averaged together should match the rate and
uncertainty for the combined value N = N_a + N_b.  Doing this for a
high Q measurement such as e.g., 

   N_a = 7, M_a=2000, N_b=13, M_b=4000, A_a=A_b=1, dA_a=dA_b=0

ields a relative error on the order of 1e-6.  Measuring a direct
beam, with the monitor rate 10% of the detector rate, e.g.,

   N_a=20400, M_a=2000, N_b=39500, M_b=4000

yields a relative error on the order of 0.02%.

The additional factor sqrt(1+N/M) due to monitor uncertainty is
significant to the calculation.  For example, the error bars 
are wrong by a factor of 3 in the direct beam example above if
monitor uncertainty is not included.

The use of Poisson error propogation is significant in low count regions 
only, and there only marginally so. Elsewhere the traditional Gaussian
propogation of error formulas:

     w = sum( 1/dy^2 )
     y = sum( y/dy^2 )/w
     dy = sqrt( 1/w )

could be used.  We use Poisson error propogation thoughout when
averaging data points.


2006-02-20}

# ----------------------------------------------------------------------
hpage {NG7 PSD} {Here's the current code for psd reduction on NG-7:

 # measured monitor M
 # pixel intensity  I

 # Look up the dead time correction for the monitor from a calibration
 # file by computing the rate and performing a linear interpolation
 # on that rate.
 t = prf*(mon + Mon1*abs(Qz)^Exp)
 rate = M/t
 c = interp(calibration,rate)

 # corrected monitor for rate (make sure it is at least 1)
 dM = sqrt(m)*c
 M = m*c
 M(M==0) = 1

 # Normalize intensity by monitor
 dI = sqrt ( (sqrt(I)/M)^2 + (I dM/M^2)^2 )
 I = I/M

 # Point k has lines of integration crossing at pixel M and N
 # Find corresponding background lines of equal area.
 # Note the clipping; background may be underestimated at high Q
 # if the integration region goes to the outer quarter of the detector
 w = (M-N+1)/2
 m = max(1, M-floor(w))
 n = min(pixels, N+ceil(w))

 # Integrate specular
 S = sum_{i=M}^N  I_i
 dS = sqrt( sum_{i=M}^N dI_i^2 )
 
 # Integrate specular + background
 T = sum_{i=m}^n I_i
 dT = sqrt( sum_{i=m}^n dI_i^2 )
 
 # Background is (specular + background) - specular
 B = T - S
 dB = sqrt(dT^2 - dS^2)

 # Reduced value is (specular - background)
 R = S - B
 dR = dT

 # In the reduce screen there will be a detector to monitor
 # ratio correction.
 
calibration:
 
   304    1.
  1788    1.0074
  6812    1.0672
 13536    1.1399
 19426    1.2151
 24022    1.2944
 27771    1.370
 31174    1.429

2005-07-19}

